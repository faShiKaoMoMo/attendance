<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·å‡ç®¡ç†</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --border-color: #dee2e6;
            --light-bg: #f8f9fa;
            --text-color: #333;
            --gray-text: #6c757d;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: var(--text-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            text-align: center;

            position: relative;
        }

        .back-link {
            position: absolute; /* ç»å¯¹å®šä½ */
            left: 30px; /* è·ç¦»å·¦è¾¹ 30px */
            top: 50%; /* å‚ç›´å±…ä¸­ */
            transform: translateY(-50%); /* ä¿®æ­£å‚ç›´å±…ä¸­åç§» */

            text-decoration: none;
            color: rgba(255, 255, 255, 0.9); /* ä½¿ç”¨ç™½è‰²åŠé€æ˜ï¼Œé€‚é…è“è‰²èƒŒæ™¯ */
            font-size: 18px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
        }

        .back-link:hover {
            color: #ffffff; /* æ‚¬åœæ—¶å˜ä¸ºçº¯ç™½ */
            transform: translateY(-50%) translateX(-3px); /* æ‚¬åœæ—¶å‘å·¦å¾®åŠ¨æ•ˆæœ */
        }

        h1 {
            margin: 0;
            font-size: 24px;
        }

        .subtitle {
            margin-top: 8px;
            opacity: 0.9;
            font-size: 16px;
        }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .content-wrapper {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* --- ç»Ÿè®¡å¡ç‰‡ --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 32px;
            margin: 0 0 5px 0;
            color: var(--primary-color);
        }

        .stat-card p {
            margin: 0;
            color: var(--gray-text);
            font-size: 14px;
        }

        /* --- æ§åˆ¶æ  --- */
        .controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .add-btn {
            padding: 0 20px;
            height: 36px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
            transition: background 0.2s;
            font-size: 14px;
        }

        .add-btn:hover {
            background-color: var(--secondary-color);
        }

        .add-btn::before {
            content: "+";
            font-size: 18px;
            font-weight: bold;
        }

        /* --- è¡¨æ ¼æ ·å¼ --- */
        .table-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .styled-table th {
            background-color: var(--light-bg);
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
            color: #343a40;
            border-bottom: 2px solid var(--border-color);
        }

        .styled-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 14px;
            color: #495057;
            text-align: center;
        }

        .styled-table tr:hover {
            background-color: #f8fafc;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .row-btn {
            height: 32px;
            padding: 0 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }

        .row-btn:hover {
            opacity: 0.9;
        }

        .btn-view {
            background-color: #17a2b8;
        }

        .btn-approve {
            background-color: var(--success-color);
        }

        .btn-reject {
            background-color: var(--danger-color);
        }

        /* --- åˆ†é¡µ --- */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            background-color: #fff;
        }

        .pagination-info {
            font-size: 13px;
            color: var(--gray-text);
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-btn {
            height: 32px;
            min-width: 32px;
            padding: 0 10px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--light-bg);
        }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--text-color);
        }

        .close-modal-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            height: 38px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            height: 100px;
            padding: 10px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            padding: 8px 20px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-submit {
            padding: 8px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .back-link {
                position: static;
                display: block;
                transform: none;
                text-align: left;
                margin-bottom: 10px;
                color: rgba(255, 255, 255, 0.9);
            }

            .back-link:hover {
                transform: translateX(-3px);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>è¯·å‡ç®¡ç†</h1>
        <div class="subtitle">ç”³è¯·ä¸ç®¡ç†è¯·å‡äº‹å®œ</div>
        <a href="{{ url_for('home') }}" class="back-link">ğŸ  è¿”å›é¦–é¡µ</a>
    </header>

    <div class="content-wrapper">
        <!-- 1. ç»Ÿè®¡åŒºåŸŸ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-requests">0</h3>
                <p>æ€»è¯·å‡è¯·æ±‚</p>
            </div>
            <div class="stat-card">
                <h3 id="pending-requests" style="color: var(--warning-color)">0</h3>
                <p>å¾…å®¡æ‰¹è¯·æ±‚</p>
            </div>
            <div class="stat-card">
                <h3 id="approved-requests" style="color: var(--success-color)">0</h3>
                <p>å·²æ‰¹å‡†è¯·æ±‚</p>
            </div>
            <div class="stat-card">
                <h3 id="completed-trips" style="color: var(--danger-color)">0</h3>
                <p>å·²é©³å›è¯·æ±‚</p>
            </div>
        </div>

        <!-- 2. æ“ä½œæ  -->
        <div class="controls">
            <button id="add-request-btn" class="add-btn">æ–°å¢è¯·å‡è¯·æ±‚</button>
        </div>

        <!-- 3. è¡¨æ ¼åŒºåŸŸ -->
        <div class="table-container">
            <table class="styled-table" id="recent-requests">
                <thead>
                <tr>
                    <!-- ç§»é™¤äº†ç›®çš„åœ°åˆ—ï¼Œè°ƒæ•´äº†å®½åº¦ -->
                    <th style="width: 20%">ç”³è¯·äºº</th>
                    <th style="width: 20%">å¼€å§‹æ—¥æœŸ</th>
                    <th style="width: 20%">ç»“æŸæ—¥æœŸ</th>
                    <th style="width: 15%">çŠ¶æ€</th>
                    <th style="width: 25%">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                <!-- åŠ¨æ€å¡«å…… -->
                </tbody>
            </table>

            <!-- åˆ†é¡µ -->
            <div class="pagination-container">
                <div class="pagination-info">
                    ç¬¬ <span id="cur-page">1</span> é¡µ / å…± <span id="total-page">1</span> é¡µï¼Œå…± <span
                        id="total-counts">0</span> æ¡
                </div>
                <div class="pagination-controls">
                    <button id="first-page" class="page-btn" disabled>é¦–é¡µ</button>
                    <button id="prev-page" class="page-btn" disabled>ä¸Šä¸€é¡µ</button>
                    <div id="page-numbers" style="display:flex; gap:4px;"></div>
                    <button id="next-page" class="page-btn" disabled>ä¸‹ä¸€é¡µ</button>
                    <button id="last-page" class="page-btn" disabled>æœ«é¡µ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢è¯·æ±‚ æ¨¡æ€æ¡† (ç§»é™¤äº†ç›®çš„åœ°ã€ç›®çš„ã€å·¥æ—¶) -->
<div id="request-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æ–°å¢è¯·å‡è¯·æ±‚</h2>
            <button class="close-modal-btn" onclick="toggleModal('request-modal', false)">&times;</button>
        </div>
        <form id="request-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="user-name">ç”³è¯·äºº *</label>
                    <input type="text" id="user-name" class="form-control" required>
                </div>
            </div>
            <!-- ç§»é™¤äº†ç›®çš„åœ°å’Œç›®çš„çš„è¡Œ -->
            <div class="form-row">
                <div class="form-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸ *</label>
                    <input type="date" id="start-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="end-date">ç»“æŸæ—¥æœŸ *</label>
                    <input type="date" id="end-date" class="form-control" required>
                </div>
            </div>
            <!-- ç§»é™¤äº†å·¥æ—¶è¡Œ -->
            <div class="form-group">
                <label for="description">è¯¦ç»†è¯´æ˜</label>
                <textarea id="description" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="toggleModal('request-modal', false)">å–æ¶ˆ</button>
                <button type="submit" class="btn-submit">æäº¤è¯·æ±‚</button>
            </div>
        </form>
    </div>
</div>

<!-- è¯¦æƒ… æ¨¡æ€æ¡† -->
<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>è¯·å‡è¯¦æƒ…</h2>
            <button class="close-modal-btn" onclick="toggleModal('detail-modal', false)">&times;</button>
        </div>
        <div id="detail-content" style="font-size: 14px; line-height: 1.8;">
            <!-- åŠ¨æ€å¡«å…… -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-submit" onclick="toggleModal('detail-modal', false)">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯/Loading å¼¹çª— (å…¬ç”¨) -->
<div id="modal" class="modal-overlay" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div id="modal-body"></div>
        <div id="modal-buttons" class="modal-footer" style="justify-content: center;"></div>
    </div>
</div>

<script>
    // ==========================================
    // JS é€»è¾‘
    // ==========================================

    const pageInfo = {
        curPage: 1,
        pageSize: 10,
        totalPages: 0,
        totalCount: 0
    };

    const ApprovalEnum = {
        "PENDING": 0,
        "APPROVED": 1,
        "REJECTED": 2
    };

    // ç»‘å®š DOM
    const requestModal = document.getElementById('request-modal');
    const detailModal = document.getElementById('detail-modal');
    const requestForm = document.getElementById('request-form');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const modalButtons = document.getElementById('modal-buttons');

    // é€šç”¨å¼¹çª—æ§åˆ¶
    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? 'flex' : 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        initPagination();
        updateDashboard();
        // ç»‘å®šæŒ‰é’®
        document.getElementById('add-request-btn').addEventListener('click', () => toggleModal('request-modal', true));

        requestForm.addEventListener('submit', function (e) {
            e.preventDefault();
            addNewRequest();
        });
    });

    // ----------------- åˆ†é¡µé€»è¾‘ -----------------
    function initPagination() {
        document.getElementById('first-page').addEventListener('click', goToFirstPage);
        document.getElementById('prev-page').addEventListener('click', goToPrevPage);
        document.getElementById('next-page').addEventListener('click', goToNextPage);
        document.getElementById('last-page').addEventListener('click', goToLastPage);
        renderRecentRequests();
    }

    function updatePaginationInfo(data) {
        pageInfo.curPage = data.pageNo || 1;
        pageInfo.totalPages = data.pages || 1;
        pageInfo.totalCount = data.total || 0;
        pageInfo.pageSize = data.size || 10;

        document.getElementById('cur-page').textContent = pageInfo.curPage;
        document.getElementById('total-page').textContent = pageInfo.totalPages;
        document.getElementById('total-counts').textContent = pageInfo.totalCount;

        renderPageNumbers();
        updatePaginationButtons();
    }

    function renderPageNumbers() {
        const container = document.getElementById('page-numbers');
        container.innerHTML = `<button class="page-btn active">${pageInfo.curPage}</button>`;
    }

    function updatePaginationButtons() {
        document.getElementById('first-page').disabled = pageInfo.curPage <= 1;
        document.getElementById('prev-page').disabled = pageInfo.curPage <= 1;
        document.getElementById('next-page').disabled = pageInfo.curPage >= pageInfo.totalPages;
        document.getElementById('last-page').disabled = pageInfo.curPage >= pageInfo.totalPages;
    }

    function goToFirstPage() {
        if (pageInfo.curPage > 1) {
            pageInfo.curPage = 1;
            renderRecentRequests();
        }
    }

    function goToPrevPage() {
        if (pageInfo.curPage > 1) {
            pageInfo.curPage--;
            renderRecentRequests();
        }
    }

    function goToNextPage() {
        if (pageInfo.curPage < pageInfo.totalPages) {
            pageInfo.curPage++;
            renderRecentRequests();
        }
    }

    function goToLastPage() {
        if (pageInfo.curPage < pageInfo.totalPages) {
            pageInfo.curPage = pageInfo.totalPages;
            renderRecentRequests();
        }
    }

    // ----------------- æ¶ˆæ¯å¼¹çª— -----------------
    function showModal(type, message) {
        modalBody.innerHTML = '';
        modalButtons.innerHTML = '';
        if (type === 'loading') {
            modalBody.innerHTML = `<div class="spinner"></div><p style="margin-top:10px">${message}</p>`;
        } else {
            modalBody.innerHTML = `<p>${message}</p>`;
            const okButton = document.createElement('button');
            okButton.className = 'btn-submit';
            okButton.textContent = 'ç¡®å®š';
            okButton.onclick = () => modal.style.display = 'none';
            modalButtons.appendChild(okButton);
        }
        modal.style.display = 'flex';
    }

    // ----------------- API é€»è¾‘ -----------------

    // 1. è·å–ç»Ÿè®¡
    async function updateDashboard() {
        try {
            const response = await fetch('/leave/counts');
            if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.statusText}`);
            const data = await response.json();

            const totalRequests = data.total || 0;
            let pendingRequests = 0;
            let approvedRequests = 0;
            let rejectedRequests = 0;

            if (data.item) {
                data.item.forEach(value => {
                    if (value.status === ApprovalEnum.PENDING) pendingRequests = value.count;
                    else if (value.status === ApprovalEnum.APPROVED) approvedRequests = value.count;
                    else if (value.status === ApprovalEnum.REJECTED) rejectedRequests = value.count;
                });
            }

            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('pending-requests').textContent = pendingRequests;
            document.getElementById('approved-requests').textContent = approvedRequests;
            document.getElementById('completed-trips').textContent = rejectedRequests;

        } catch (error) {
            console.error('ç»Ÿè®¡åŠ è½½å¤±è´¥', error);
        }
    }

    // 2. è·å–åˆ—è¡¨
    async function renderRecentRequests() {
        const tableBody = document.querySelector('#recent-requests tbody');
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center">åŠ è½½ä¸­...</td></tr>'; // colspan æ”¹ä¸º 5

        try {
            const response = await fetch("/leave/list?pageNo=" + pageInfo.curPage + "&pageSize=" + pageInfo.pageSize);
            if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
            const data = await response.json();
            const recentTrips = data.list || [];

            tableBody.innerHTML = '';
            if (recentTrips.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            recentTrips.forEach(trip => {
                const row = document.createElement('tr');
                let statusClass = '', statusText = '';

                switch (trip.status) {
                    case ApprovalEnum.PENDING:
                        statusClass = 'status-pending';
                        statusText = 'å¾…å®¡æ‰¹';
                        break;
                    case ApprovalEnum.APPROVED:
                        statusClass = 'status-approved';
                        statusText = 'å·²æ‰¹å‡†';
                        break;
                    case ApprovalEnum.REJECTED:
                        statusClass = 'status-rejected';
                        statusText = 'å·²æ‹’ç»';
                        break;
                }

                // ç§»é™¤äº†ç›®çš„åœ°åˆ—
                row.innerHTML = `
                    <td>${trip.name}</td>
                    <td>${formatDate(trip.start_date)}</td>
                    <td>${formatDate(trip.end_date)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        <button class="row-btn btn-view" onclick="viewRequestDetails(${trip.id})">æŸ¥çœ‹</button>
                        <button class="row-btn btn-approve" onclick="approve(${trip.id}, ${trip.status})">æ‰¹å‡†</button>
                        <button class="row-btn btn-reject" onclick="reject(${trip.id}, ${trip.status})">é©³å›</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePaginationInfo(data);

        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // 3. æ–°å¢è¯·æ±‚
    async function addNewRequest() {
        // æ„å»ºè¯·æ±‚å¯¹è±¡ï¼Œå·²ç§»é™¤çš„å­—æ®µä¼ ç©ºå€¼ï¼Œé˜²æ­¢åç«¯æŠ¥é”™
        const newRequest = {
            'name': document.getElementById('user-name').value,
            'destination': "", // å‰ç«¯å·²ç§»é™¤ï¼Œä¼ ç©º
            'reason': "",      // å‰ç«¯å·²ç§»é™¤ï¼Œä¼ ç©º
            'start_date': document.getElementById('start-date').value,
            'end_date': document.getElementById('end-date').value,
            'avg_working_hours': 0, // å‰ç«¯å·²ç§»é™¤ï¼Œä¼ 0
            'description': document.getElementById('description').value,
            'status': ApprovalEnum.PENDING,
        };

        toggleModal('request-modal', false);
        showModal('loading', 'æäº¤ä¸­...');

        try {
            const response = await fetch('/leave/add', {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newRequest)
            });
            if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯`);
            const result = await response.json();

            if (result.success) {
                showModal('success', 'ä¿å­˜æˆåŠŸï¼');
                updateDashboard();
                renderRecentRequests();
                requestForm.reset();
            } else {
                throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            showModal('error', `ä¿å­˜å¤±è´¥: ${error.message}`);
        }
    }

    // 4. æŸ¥çœ‹è¯¦æƒ…
    async function viewRequestDetails(id) {
        showModal('loading', 'åŠ è½½è¯¦æƒ…...');
        try {
            const response = await fetch('/leave/info?id=' + id);
            if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯`);
            const trip = await response.json();

            // å…³é—­loading
            modal.style.display = 'none';

            let statusText = ['å¾…å®¡æ‰¹', 'å·²æ‰¹å‡†', 'å·²æ‹’ç»'][trip.status] || 'æœªçŸ¥';

            const content = document.getElementById('detail-content');
            // ç§»é™¤äº†ç›®çš„åœ°ã€ç›®çš„ã€å·¥æ—¶çš„æ˜¾ç¤º
            content.innerHTML = `
                <div style="margin-bottom:10px"><strong>ç”³è¯·äººï¼š</strong> ${trip.name}</div>
                <div style="margin-bottom:10px"><strong>æ—¶é—´ï¼š</strong> ${formatDate(trip.start_date)} è‡³ ${formatDate(trip.end_date)}</div>
                <div style="margin-bottom:10px"><strong>çŠ¶æ€ï¼š</strong> ${statusText}</div>
                <div style="margin-bottom:10px"><strong>æäº¤æ—¶é—´ï¼š</strong> ${formatDate(trip.create_date)}</div>
                <div style="border-top:1px solid #eee; padding-top:10px; margin-top:10px">
                    <strong>è¯´æ˜ï¼š</strong><br>${trip.description || 'æ— '}
                </div>
            `;
            toggleModal('detail-modal', true);
        } catch (e) {
            showModal('error', 'åŠ è½½è¯¦æƒ…å¤±è´¥');
        }
    }

    // 5. æ‰¹å‡†
    async function approve(id, status) {
        if (status !== ApprovalEnum.PENDING) return showModal('error', `å½“å‰çŠ¶æ€ä¸å…è®¸æ‰§è¡Œæ“ä½œ!`);
        await handleApproval(id, ApprovalEnum.APPROVED);
    }

    // 6. é©³å›
    async function reject(id, status) {
        if (status !== ApprovalEnum.PENDING) return showModal('error', `å½“å‰çŠ¶æ€ä¸å…è®¸æ‰§è¡Œæ“ä½œ!`);
        await handleApproval(id, ApprovalEnum.REJECTED);
    }

    async function handleApproval(id, newStatus) {
        showModal('loading', 'å¤„ç†ä¸­...');
        try {
            const response = await fetch('/leave/approval', {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({"id": id, "status": newStatus})
            });
            if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯`);

            showModal('success', 'æ“ä½œæˆåŠŸ');
            updateDashboard();
            renderRecentRequests();
        } catch (e) {
            showModal('error', `æ“ä½œå¤±è´¥: ${e.message}`);
        }
    }

    // è¾…åŠ©å‡½æ•°
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
    }
</script>
</body>
</html>