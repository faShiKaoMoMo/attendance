<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿè¯¾è¡¨</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --tab-width: 130px; /* å·¦ä¾§Tabå®½åº¦ */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            text-align: center;
            flex-shrink: 0;

            position: relative;
        }

        .back-link {
            position: absolute; /* ç»å¯¹å®šä½ */
            left: 30px; /* è·ç¦»å·¦è¾¹ 30px */
            top: 50%; /* å‚ç›´å±…ä¸­ */
            transform: translateY(-50%); /* ä¿®æ­£å‚ç›´å±…ä¸­åç§» */

            text-decoration: none;
            color: rgba(255, 255, 255, 0.9); /* ä½¿ç”¨ç™½è‰²åŠé€æ˜ï¼Œé€‚é…è“è‰²èƒŒæ™¯ */
            font-size: 18px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
        }

        .back-link:hover {
            color: #ffffff; /* æ‚¬åœæ—¶å˜ä¸ºçº¯ç™½ */
            transform: translateY(-50%) translateX(-3px); /* æ‚¬åœæ—¶å‘å·¦å¾®åŠ¨æ•ˆæœ */
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .subtitle {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }

        .controls-container {
            padding: 15px 30px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; /* å·¦å³åˆ†å¸ƒ */
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .date-controls {
            display: flex;
            align-items: center;
            background-color: #f8fafc;
            border: 1px solid var(--border-color);
            padding: 16px 15px;
            border-radius: 8px;
            gap: 15px;
        }

        .date-label-main {
            font-weight: 600;
            color: var(--secondary-color);
            margin-right: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .date-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .date-input-wrapper label {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .date-separator {
            color: #95a5a6;
            font-size: 14px;
        }

        input[type="date"] {
            padding: 5px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            color: var(--dark-color);
            min-width: 120px;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        #save-btn {
            padding: 8px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
        }

        #save-btn:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§æ—¶é—´Tabæ  */
        .time-sidebar {
            width: var(--tab-width);
            background-color: #f8f9fa;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .time-tab {
            padding: 20px 10px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            border-left: 4px solid transparent;
            transition: var(--transition);
            background-color: #f8f9fa;
            color: #555;
            font-weight: 500;
            text-align: center;
        }

        .time-tab:hover {
            background-color: #e2e6ea;
        }

        .time-tab.active {
            background-color: white;
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            margin-right: -1px; /* ç›–ä½å³è¾¹æ¡† */
        }

        .time-tab .time-text {
            font-size: 16px;
            display: block;
        }

        /* å³ä¾§å†…å®¹å±•ç¤ºåŒº */
        .content-area {
            flex: 1;
            background-color: white;
            overflow: auto; /* å…è®¸xyè½´æ»šåŠ¨ */
            padding: 20px;
        }

        .day-columns-container {
            display: none;
            grid-template-columns: repeat(5, minmax(220px, 1fr));
            gap: 15px;
            height: 100%;
            width: 100%;
        }

        .day-columns-container.active {
            display: grid;
        }

        .day-column {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            height: fit-content;
            min-height: 250px;
        }

        .day-header {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
        }

        .day-body {
            padding: 10px;
            flex: 1;
        }

        .entry-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 6px;
            background-color: #f0f7ff;
            border: 1px solid #d0e3ff;
            transition: var(--transition);
        }

        .entry-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .entry-item input {
            flex-grow: 1;
            min-width: 0;
            border: 1px solid #ced4da;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .entry-item input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .entry-item select {
            width: 70px;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .delete-entry-btn {
            cursor: pointer;
            background: transparent;
            color: #999;
            border: none;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            padding: 0 5px;
        }

        .delete-entry-btn:hover {
            color: var(--danger-color);
        }

        .add-person-btn {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background-color: white;
            border: 1px dashed var(--primary-color);
            color: var(--primary-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .add-person-btn:hover {
            background-color: #f0f7ff;
        }

        .empty-hint {
            color: #adb5bd;
            font-style: italic;
            font-size: 13px;
            text-align: center;
            padding: 20px 0;
            display: block;
        }

        .week-type-all {
            border-left: 3px solid #27ae60;
        }

        .week-type-odd {
            border-left: 3px solid #e74c3c;
        }

        .week-type-even {
            border-left: 3px solid #3498db;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 300px;
        }

        .modal-content button {
            padding: 8px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
        }

        .semester-add-btn {
            padding: 10px 20px;
            background-color: var(--primary-color); /* è“è‰² */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
            transition: var(--transition);
        }

        .semester-add-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .semester-add-btn::before {
            content: "+";
            font-size: 18px;
            font-weight: bold;
        }

        .semester-enable-btn {
            padding: 10px 20px;
            background-color: var(--success-color); /* ç»¿è‰² */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(39, 174, 96, 0.3);
            transition: var(--transition);
        }

        .semester-enable-btn:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .semester-enable-btn::before {
            content: "âœ”";
            font-size: 16px;
            font-weight: bold;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .semester-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            margin-left: 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
        }

        .semester-status-badge.status-on {
            background-color: rgba(39, 174, 96, 0.12);
            color: #27ae60;
        }

        .semester-status-badge.status-off {
            background-color: rgba(149, 165, 166, 0.15);
            color: #7f8c8d;
        }

        #semester-title {
            margin-right: 40px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: 100vh;
            }

            .main-layout {
                flex-direction: column;
            }

            .time-sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .time-tab {
                padding: 10px 15px;
                flex-shrink: 0;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .time-tab.active {
                border-bottom-color: var(--primary-color);
                margin-right: 0;
            }

            /* ç§»åŠ¨ç«¯å¼ºåˆ¶å•åˆ— */
            .day-columns-container {
                grid-template-columns: 1fr;
            }

            .day-column {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <a href="{{ url_for('home') }}" class="back-link">ğŸ  è¿”å›é¦–é¡µ</a>
        <h1>å­¦ç”Ÿè¯¾è¡¨</h1>
        <div class="subtitle">ç®¡ç†æ’è¯¾è®¡åˆ’ä¸æ¯æ—¥å®‰æ’</div>
    </header>

    <div class="controls-container">
        <div class="date-controls">
            <div class="date-label-main"><span>ğŸ“… å­¦æœŸæ—¶é—´</span></div>
            <div class="date-group">
                <div class="date-input-wrapper">
                    <input type="date" id="start-date">
                </div>
                <div class="date-separator">âœ</div>
                <div class="date-input-wrapper">
                    <input type="date" id="end-date">
                </div>
            </div>
        </div>
        <button id="save-btn">ä¿å­˜æ›´æ”¹</button>
    </div>

    <div class="main-layout">
        <!-- å·¦ä¾§ï¼šæ—¶é—´æ®µTabs -->
        <div id="time-sidebar" class="time-sidebar"></div>
        <!-- å³ä¾§ï¼šå‘¨ä¸€åˆ°å‘¨äº”çš„å†…å®¹åŒº -->
        <div id="content-area" class="content-area"></div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="modal" class="modal-overlay">
    <div class="modal-content">
        <div id="modal-body"></div>
        <div id="modal-buttons" class="modal-buttons"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        /* ================= DOM ================= */
        const timeSidebar = document.getElementById('time-sidebar');
        const contentArea = document.getElementById('content-area');
        const saveBtn = document.getElementById('save-btn');
        saveBtn.style.display = "none";  // ä¸ç”¨ä¿å­˜æŒ‰é’®

        const startDatePicker = document.getElementById('start-date');
        const endDatePicker = document.getElementById('end-date');
        startDatePicker.disabled = true;
        endDatePicker.disabled = true;

        const controlsContainer = document.querySelector(".controls-container");
        const dateControls = document.querySelector(".date-controls");

        /* ========== æ›¿æ¢æ‰â€œå­¦æœŸæ—¶é—´â€æ ‡ç­¾ ========== */
        const titleContainer = document.createElement("div");
        titleContainer.style.fontWeight = "600";
        titleContainer.style.color = "#2c3e50";
        titleContainer.style.fontSize = "18px";
        titleContainer.id = "semester-title";

        dateControls.querySelector(".date-label-main").replaceWith(titleContainer);
        const semesterTitle = document.getElementById("semester-title");

        /* ========== å·¦ä¾§ï¼šç®­å¤´ + æ—¥æœŸå— åˆ†ç»„ ========== */
        const leftGroup = document.createElement("div");
        leftGroup.style.display = "flex";
        leftGroup.style.alignItems = "center";
        leftGroup.style.gap = "8px";

        // æŠŠåŸæ¥çš„ dateControls ç§»åˆ°å·¦ä¾§åˆ†ç»„
        controlsContainer.insertBefore(leftGroup, dateControls);

        const prevBtn = createArrowButton("â—€");
        const nextBtn = createArrowButton("â–¶");

        leftGroup.appendChild(prevBtn);
        leftGroup.appendChild(dateControls);
        leftGroup.appendChild(nextBtn);

        /* ========== å³ä¾§ï¼šæ–°å¢å­¦æœŸ / å¯ç”¨å­¦æœŸ ========== */
        const actionGroup = document.createElement("div");
        actionGroup.style.display = "flex";
        actionGroup.style.alignItems = "center";
        actionGroup.style.gap = "10px";

        const addSemesterBtn = document.createElement("button");
        addSemesterBtn.className = "semester-add-btn";
        addSemesterBtn.textContent = "æ–°å¢å­¦æœŸ";

        const enableSemesterBtn = document.createElement("button");
        enableSemesterBtn.className = "semester-enable-btn";
        enableSemesterBtn.textContent = "å¯ç”¨å­¦æœŸ";

        actionGroup.appendChild(addSemesterBtn);
        actionGroup.appendChild(enableSemesterBtn);

        // æ”¾åœ¨æœ€å³ä¾§ï¼ˆåœ¨éšè—çš„ saveBtn å‰/åéƒ½æ— æ‰€è°“ï¼‰
        controlsContainer.appendChild(actionGroup);

        /* ========== æŒ‰é’®æ ·å¼å‡½æ•° ========== */
        function createArrowButton(symbol) {
            const btn = document.createElement("button");
            btn.textContent = symbol;
            btn.style.width = "32px";
            btn.style.height = "32px";
            btn.style.borderRadius = "50%";
            btn.style.border = "1px solid #ccc";
            btn.style.background = "white";
            btn.style.cursor = "pointer";
            btn.style.display = "flex";
            btn.style.alignItems = "center";
            btn.style.justifyContent = "center";
            btn.style.fontSize = "16px";
            btn.style.lineHeight = "1";
            btn.style.transition = "var(--transition)";
            btn.onmouseenter = () => {
                btn.style.background = "#f0f0f0";
                btn.style.borderColor = "var(--primary-color)";
            };
            btn.onmouseleave = () => {
                btn.style.background = "white";
                btn.style.borderColor = "#ccc";
            };
            return btn;
        }

        function disableBtn(btn) {
            btn.disabled = true;
            btn.style.opacity = "0.4";
            btn.style.cursor = "not-allowed";
        }

        function enableBtn(btn) {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
        }

        /* ================= å¼¹çª—ï¼ˆmodalï¼‰ ================= */
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const modalButtons = document.getElementById('modal-buttons');

        function createPrimaryBtn(text) {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.style.padding = "8px 20px";
            btn.style.fontSize = "15px";
            btn.style.fontWeight = "500";
            btn.style.background = "var(--primary-color)";
            btn.style.color = "white";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.transition = "var(--transition)";
            btn.style.boxShadow = "0 2px 4px rgba(52,152,219,0.2)";
            btn.onmouseenter = () => btn.style.background = "var(--secondary-color)";
            btn.onmouseleave = () => btn.style.background = "var(--primary-color)";
            return btn;
        }

        function createGrayBtn(text) {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.style.padding = "8px 20px";
            btn.style.fontSize = "15px";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.background = "#ccc";
            btn.style.color = "#333";
            btn.style.transition = "var(--transition)";
            btn.onmouseenter = () => btn.style.background = "#bcbcbc";
            btn.onmouseleave = () => btn.style.background = "#ccc";
            return btn;
        }

        function showAddDialog(week, slot) {
            modalBody.innerHTML = `
            <p style="font-size:17px;font-weight:600;margin-bottom:15px;">æ·»åŠ æ’è¯¾</p>

            <div style="width:260px;margin:0 auto;text-align:left;">
                <label style="font-size:13px;color:#555;">å§“å</label>
                <input id="dlg-name"
                    style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;">

                <label style="font-size:13px;color:#555;margin-top:12px;display:block;">å•åŒå‘¨</label>
                <select id="dlg-type"
                    style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="odd">å•å‘¨</option>
                    <option value="even">åŒå‘¨</option>
                </select>
            </div>
        `;
            modalButtons.innerHTML = "";

            const ok = createPrimaryBtn("ç¡®å®š");
            ok.style.marginRight = "10px";
            ok.onclick = () => {
                const name = document.getElementById("dlg-name").value.trim();
                const type = document.getElementById("dlg-type").value;
                if (!name) {
                    alert("è¯·è¾“å…¥å§“å");
                    return;
                }
                modal.style.display = "none";
                addItem(currentSemesterId, name, week, slot, type);
            };

            const cancel = createGrayBtn("å–æ¶ˆ");
            cancel.onclick = () => modal.style.display = "none";

            modalButtons.appendChild(ok);
            modalButtons.appendChild(cancel);
            modal.style.display = "flex";
        }

        /* ================= API & çŠ¶æ€ ================= */
        let semesterList = [];
        let currentIndex = 0;
        let currentSemesterId = null;
        let currentSlotIndex = 0;  // å½“å‰æ¿€æ´»çš„æ—¶é—´æ®µç´¢å¼•

        // å¯é€‰ä¼  selectedIdï¼šæŒ‡å®šåŠ è½½åé€‰ä¸­çš„å­¦æœŸ
        async function loadSemesterList(selectedId = null) {
            const r = await fetch("/class/list");
            semesterList = await r.json();

            if (selectedId !== null) {
                const idx = semesterList.findIndex(s => s.id === selectedId);
                if (idx !== -1) {
                    currentIndex = idx;
                } else {
                    // å¦‚æœæ²¡æ‰¾åˆ°æŒ‡å®šIDï¼Œé€€å›åˆ°å¯ç”¨å­¦æœŸé€»è¾‘
                    currentIndex = semesterList.findIndex(s => s.enable === 1);
                    if (currentIndex === -1) currentIndex = 0;
                }
            } else {
                currentIndex = semesterList.findIndex(s => s.enable === 1);
                if (currentIndex === -1) currentIndex = 0;
            }

            applySemester();
        }

        function applySemester() {
            if (!semesterList.length) {
                semesterTitle.textContent = "æš‚æ— å­¦æœŸ";
                startDatePicker.value = "";
                endDatePicker.value = "";
                disableBtn(prevBtn);
                disableBtn(nextBtn);
                timeSidebar.innerHTML = "";
                contentArea.innerHTML = "";
                return;
            }

            const sem = semesterList[currentIndex];
            currentSemesterId = sem.id;

            // æ ¹æ® enable å­—æ®µåˆ¤æ–­æ˜¯å¦å¯ç”¨
            const enabled = sem.enable === 1;

            semesterTitle.innerHTML = `
        <span>${sem.name}</span>
        <span class="semester-status-badge ${enabled ? 'status-on' : 'status-off'}">
            ${enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
        </span>
    `;

            startDatePicker.value = sem.start_date;
            endDatePicker.value = sem.end_date;

            if (currentIndex === 0) disableBtn(prevBtn); else enableBtn(prevBtn);
            if (currentIndex === semesterList.length - 1) disableBtn(nextBtn); else enableBtn(nextBtn);

            // åˆ‡æ¢å­¦æœŸæ—¶å›åˆ°ç¬¬ä¸€ä¸ªæ—¶é—´æ®µ
            currentSlotIndex = 0;

            loadItems(sem.id);
        }

        prevBtn.onclick = () => {
            if (currentIndex > 0) {
                currentIndex--;
                applySemester();
            }
        };
        nextBtn.onclick = () => {
            if (currentIndex < semesterList.length - 1) {
                currentIndex++;
                applySemester();
            }
        };

        // æ–°å¢å­¦æœŸï¼šè°ƒç”¨ /class/addï¼Œæ–°å¢ååˆ‡åˆ°æ–°å­¦æœŸ
        addSemesterBtn.onclick = showAddSemesterDialog;

        // å¯ç”¨å½“å‰å­¦æœŸï¼šè°ƒç”¨ /class/<id>/enable
        enableSemesterBtn.onclick = async () => {
            if (!currentSemesterId) {
                alert("å½“å‰æ²¡æœ‰å¯å¯ç”¨çš„å­¦æœŸ");
                return;
            }
            try {
                await fetch(`/class/${currentSemesterId}/enable`, {method: "POST"});
                // å¯ç”¨åï¼Œä»ç„¶ä¿æŒåœ¨å½“å‰å­¦æœŸ
                await loadSemesterList(currentSemesterId);
            } catch (e) {
                console.error(e);
                alert("å¯ç”¨å­¦æœŸå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
        };

        async function loadItems(id) {
            const r = await fetch(`/class/${id}/item`);
            const items = await r.json();
            renderSchedule(items);
        }

        async function addItem(semId, name, week, slot, type) {
            await fetch(`/class/${semId}/item/add`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    name, week, slot: slot.join(" - "), type
                })
            });
            loadItems(semId);
        }

        async function deleteItem(semId, itemId) {
            await fetch(`/class/${semId}/item/${itemId}/delete`, {method: "POST"});
            loadItems(semId);
        }

        /* ================= è¯¾è¡¨æ¸²æŸ“ ================= */

        const FIXED_TIME_SLOTS = [
            ["08:00", "09:40"],
            ["10:10", "11:50"],
            ["14:30", "16:10"],
            ["16:40", "18:20"],
            ["19:10", "20:50"],
            ["21:00", "21:45"],
        ];
        const DAYS = ["æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”"];
        const WEEK_TYPES = {all: "å…¨éƒ¨", odd: "å•å‘¨", even: "åŒå‘¨"};

        function renderSchedule(items) {
            timeSidebar.innerHTML = "";
            contentArea.innerHTML = "";

            FIXED_TIME_SLOTS.forEach((slot, idx) => {
                const slotStr = `${slot[0]} - ${slot[1]}`;
                const contentId = `content-${idx}`;

                /* å·¦ä¾§æ—¶é—´ tab */
                const tab = document.createElement("div");
                tab.className = `time-tab ${idx === currentSlotIndex ? "active" : ""}`;
                tab.dataset.target = contentId;
                tab.innerHTML = `<span class="time-text">${slotStr}</span>`;
                tab.onclick = () => {
                    currentSlotIndex = idx;          // è®°ä½å½“å‰é€‰ä¸­çš„æ—¶é—´æ®µ
                    switchTab(tab, contentId);
                };
                timeSidebar.appendChild(tab);

                /* å³ä¾§å†…å®¹ */
                const container = document.createElement("div");
                container.id = contentId;
                container.className = `day-columns-container ${idx === currentSlotIndex ? "active" : ""}`;

                for (let w = 0; w < 5; w++) {
                    const col = document.createElement("div");
                    col.className = "day-column";

                    const header = document.createElement("div");
                    header.className = "day-header";
                    header.textContent = DAYS[w];
                    col.appendChild(header);

                    const body = document.createElement("div");
                    body.className = "day-body";

                    const list = items.filter(it => it.week === w && it.slot === slotStr);

                    if (list.length === 0) {
                        const s = document.createElement("span");
                        s.className = "empty-hint";
                        s.textContent = "æš‚æ— å®‰æ’";
                        body.appendChild(s);
                    } else {
                        list.forEach(it => body.appendChild(createItemElement(it)));
                    }

                    const addBtn = document.createElement("button");
                    addBtn.className = "add-person-btn";
                    addBtn.textContent = "+ æ·»åŠ äººå‘˜";
                    addBtn.onclick = () => showAddDialog(w, slot);

                    col.appendChild(body);
                    col.appendChild(addBtn);
                    container.appendChild(col);
                }

                contentArea.appendChild(container);
            });
        }

        function createItemElement(it) {
            const div = document.createElement("div");
            div.className = `entry-item week-type-${it.type}`;

            const nameBox = document.createElement("input");
            nameBox.value = it.name;
            nameBox.disabled = true;
            nameBox.style.background = "white";
            nameBox.style.color = "#333";
            nameBox.style.opacity = "1";
            nameBox.style.cursor = "default";

            const select = document.createElement("select");
            select.disabled = true;
            for (const [k, v] of Object.entries(WEEK_TYPES)) {
                const opt = document.createElement("option");
                opt.value = k;
                opt.textContent = v;
                if (k === it.type) opt.selected = true;
                select.appendChild(opt);
            }
            select.style.background = "white";
            select.style.color = "#333";
            select.style.opacity = "1";
            select.style.cursor = "default";

            const del = document.createElement("button");
            del.className = "delete-entry-btn";
            del.textContent = "Ã—";
            del.onclick = () => deleteItem(currentSemesterId, it.id);

            div.appendChild(nameBox);
            div.appendChild(select);
            div.appendChild(del);
            return div;
        }

        function switchTab(tab, id) {
            document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.day-columns-container')
                .forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showAddSemesterDialog() {
            // å¡«å……å¼¹çª—å†…å®¹
            modalBody.innerHTML = `
        <p style="font-size:17px;font-weight:600;margin-bottom:18px;">æ–°å¢å­¦æœŸ</p>

        <div style="width:280px;margin:0 auto;text-align:left;">
            <label style="font-size:13px;color:#555;">å­¦æœŸåç§°</label>
            <input id="dlg-sem-name"
                   style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;">

            <label style="font-size:13px;color:#555;margin-top:12px;display:block;">å¼€å§‹æ—¥æœŸ</label>
            <input id="dlg-sem-start"
                   type="date"
                   style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;">

            <label style="font-size:13px;color:#555;margin-top:12px;display:block;">ç»“æŸæ—¥æœŸ</label>
            <input id="dlg-sem-end"
                   type="date"
                   style="width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;">
        </div>
    `;

            modalButtons.innerHTML = "";

            const ok = createPrimaryBtn("ç¡®å®š");
            ok.style.marginRight = "10px";
            ok.onclick = async () => {
                const name = document.getElementById("dlg-sem-name").value.trim();
                const start = document.getElementById("dlg-sem-start").value;
                const end = document.getElementById("dlg-sem-end").value;

                if (!name || !start || !end) {
                    alert("è¯·å®Œæ•´å¡«å†™å­¦æœŸåç§°å’Œèµ·æ­¢æ—¥æœŸ");
                    return;
                }

                if (start > end) {
                    alert("å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ");
                    return;
                }

                try {
                    const resp = await fetch("/class/add", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            name: name,
                            start_date: start,
                            end_date: end
                        })
                    });

                    const data = await resp.json();

                    if (!resp.ok || !data.success) {
                        alert("æ–°å¢å­¦æœŸå¤±è´¥ï¼š" + (data.error || "æœåŠ¡å™¨é”™è¯¯"));
                        return;
                    }

                    modal.style.display = "none";

                    // è®©åˆ—è¡¨åˆ·æ–°å¹¶æ»šåŠ¨åˆ°æ–°å»ºçš„é‚£ä¸ªå­¦æœŸ
                    await loadSemesterList(data.id);

                } catch (e) {
                    console.error(e);
                    alert("æ–°å¢å­¦æœŸå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                }
            };

            const cancel = createGrayBtn("å–æ¶ˆ");
            cancel.onclick = () => {
                modal.style.display = "none";
            };

            modalButtons.appendChild(ok);
            modalButtons.appendChild(cancel);

            modal.style.display = "flex";
        }

        loadSemesterList();

    });
</script>
</body>
</html>
