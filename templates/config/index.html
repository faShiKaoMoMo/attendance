<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤é…ç½®</title>
    <style>
        /* --- å…¨å±€åŸºç¡€æ ·å¼ (ä¿æŒä¸å˜) --- */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12; /* æ–°å¢è­¦å‘Šè‰²ç”¨äºè°ƒè¯¾ */
            --border-color: #dee2e6;
            --light-bg: #f8f9fa;
            --text-color: #333;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: var(--text-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        .back-link {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
        }

        .back-link:hover {
            color: #ffffff;
            transform: translateY(-50%) translateX(-3px);
        }

        h1 {
            margin: 0;
            font-size: 24px;
        }

        .subtitle {
            margin-top: 8px;
            opacity: 0.9;
            font-size: 16px;
        }

        /* --- å¯¼èˆªæ  --- */
        .tabs-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            padding: 0 30px;
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            font-size: 16px;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content-wrapper {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-pane {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .tab-pane.active {
            display: flex;
        }

        /* --- é€šç”¨æ§ä»¶ --- */
        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .add-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
            transition: all 0.2s;
        }

        .add-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* --- è¡¨æ ¼æ ·å¼ (ç”¨äºå®éªŒå®¤å’Œè´¦å·) --- */
        .table-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            flex-grow: 1;
            margin-bottom: 20px;
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            table-layout: fixed;
        }

        .styled-table th {
            background-color: var(--light-bg);
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            color: #343a40;
        }

        .styled-table tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .styled-table tr:hover {
            background-color: #f8fafc;
        }

        .styled-table td {
            border: none;
            padding: 8px 10px;
            vertical-align: middle;
        }

        .styled-table input, .styled-table select {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            color: #495057;
            display: block;
            transition: border-color 0.2s;
        }

        .styled-table input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .row-btn {
            height: 36px;
            padding: 0 15px;
            font-size: 13px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            transition: transform 0.1s;
        }

        .save-row-btn {
            background-color: var(--success-color);
        }

        .delete-row-btn {
            background-color: var(--danger-color);
        }

        .pagination-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            padding: 6px 12px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* ==================== ğŸ“… æ–°å¢æ—¥å†ç›¸å…³æ ·å¼ ==================== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 24px; /* æ ‡é¢˜ä¹ŸåŠ å¤§ */
            font-weight: bold;
        }

        .calendar-nav-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px; /* æŒ‰é’®æ–‡å­—åŠ å¤§ */
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background-color: #f1f3f5;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            color: #495057;
            font-size: 18px; /* æ˜ŸæœŸè¡¨å¤´åŠ å¤§ */
        }

        .calendar-cell {
            background-color: white;
            min-height: 120px; /* æ ¼å­é«˜åº¦å¢åŠ ï¼Œå®¹çº³å¤§å­—ä½“ */
            padding: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* æ”¹ä¸ºä»ä¸Šåˆ°ä¸‹æ’åˆ— */
            gap: 8px;
        }

        .calendar-cell:hover {
            background-color: #f8faff;
        }

        .calendar-cell.other-month {
            background-color: #fafafa;
            color: #adb5bd;
            pointer-events: none;
        }

        .calendar-cell.today {
            background-color: #e8f4fd;
        }

        .day-number {
            font-size: 18px; /* æ—¥æœŸæ•°å­—åŠ å¤§ (åŸ18px) */
            font-weight: 700;
            margin-bottom: 5px;
            line-height: 1;
        }

        /* æ ‡ç­¾æ ·å¼ä¼˜åŒ– */
        .event-badge {
            font-size: 14px; /* æ ‡ç­¾æ–‡å­—åŠ å¤§ (åŸ12px) */
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* é¢œè‰²ä¿®æ”¹ï¼šæ”¾å‡ç”¨ç»¿è‰²ï¼Œè°ƒè¯¾ç”¨æ©™è‰² */
        .badge-holiday {
            background-color: #27ae60;
        }

        /* é²œè‰³çš„ç»¿è‰² */
        .badge-swap {
            background-color: #e67e22;
        }

        /* é²œè‰³çš„æ©™è‰² */

        .event-desc {
            font-size: 14px; /* å¤‡æ³¨æ–‡å­—åŠ å¤§ */
            color: #666;
            line-height: 1.4;
        }

        /* æ¨¡æ€æ¡†æ ·å¼å¢å¼º */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            color: white;
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        /* æ—‹è½¬åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <a href="{{ url_for('home') }}" class="back-link">ğŸ  è¿”å›é¦–é¡µ</a>
        <h1>è€ƒå‹¤é…ç½®</h1>
        <div class="subtitle">ç®¡ç†è€ƒå‹¤é…ç½®ä¸å‚æ•°</div>
    </header>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('lab')">å®éªŒå®¤é…ç½®</button>
        <button class="tab-btn" onclick="switchTab('account')">è´¦å·é…ç½®</button>
        <button class="tab-btn" onclick="switchTab('calendar')">è°ƒè¯¾æ—¥å†</button>
    </div>

    <div class="tab-content-wrapper">

        <!-- 1. å®éªŒå®¤é…ç½® (ä¿æŒä¸å˜) -->
        <div id="lab-tab" class="tab-pane active">
            <div class="controls">
                <button onclick="addRow('lab')" class="add-btn">ï¼‹ æ–°å¢å®éªŒå®¤</button>
            </div>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                    <tr>
                        <th style="width: 15%;">æ ¡åŒº</th>
                        <th style="width: 15%;">å®éªŒå®¤</th>
                        <th style="width: 50%;">æ’é™¤äººå‘˜ (é€—å·åˆ†éš”)</th>
                        <th style="width: 20%;">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="lab-list"></tbody>
                </table>
            </div>
            <div class="pagination-container" id="lab-pagination"></div>
        </div>

        <!-- 2. è´¦å·é…ç½® (ä¿æŒä¸å˜) -->
        <div id="account-tab" class="tab-pane">
            <div class="controls">
                <button onclick="addRow('account')" class="add-btn">ï¼‹ æ–°å¢è´¦å·</button>
            </div>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                    <tr>
                        <th style="width: 10%;">å§“å</th>
                        <th style="width: 10%;">æ‰‹æœºå·</th>
                        <th style="width: 30%;">å¯†ç </th>
                        <th style="width: 30%;">é‚®ç®± (é€—å·åˆ†éš”)</th> <!-- ç»™äºˆæœ€å¤§ç©ºé—´ -->
                        <th style="width: 20%;">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="account-list"></tbody>
                </table>
            </div>
            <div class="pagination-container" id="account-pagination"></div>
        </div>

        <!-- 3. æ—¥å†è°ƒä¼‘ (å…¨æ–°è®¾è®¡) -->
        <div id="calendar-tab" class="tab-pane">
            <!-- æ—¥å†å¤´éƒ¨å¯¼èˆª -->
            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="changeMonth(-1)">â®</button>
                <span id="current-month-display">2023 å¹´ 12 æœˆ</span>
                <button class="calendar-nav-btn" onclick="changeMonth(1)">â¯</button>
            </div>

            <!-- æ—¥å†ç½‘æ ¼ -->
            <div class="calendar-grid">
                <!-- æ˜ŸæœŸè¡¨å¤´ -->
                <div class="calendar-day-header">å‘¨æ—¥</div>
                <div class="calendar-day-header">å‘¨ä¸€</div>
                <div class="calendar-day-header">å‘¨äºŒ</div>
                <div class="calendar-day-header">å‘¨ä¸‰</div>
                <div class="calendar-day-header">å‘¨å››</div>
                <div class="calendar-day-header">å‘¨äº”</div>
                <div class="calendar-day-header">å‘¨å…­</div>

                <!-- JSå°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥æ—¥æœŸæ ¼å­ -->
                <div id="calendar-body" style="display: contents;"></div>
            </div>
        </div>

    </div>
</div>

<!-- é€šç”¨æç¤ºæ¡† (Loading/Success/Error) -->
<div id="msg-modal" class="modal-overlay">
    <div class="modal-content" style="text-align: center; width: 320px;">
        <div id="msg-body"></div>
        <div id="msg-buttons" style="margin-top: 20px;"></div>
    </div>
</div>

<!-- ğŸ“… æ—¥å†ç¼–è¾‘å¼¹çª— -->
<div id="calendar-edit-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title" id="cal-modal-title">é…ç½®è¯¦æƒ…</div>
        <input type="hidden" id="cal-id">
        <input type="hidden" id="cal-date">

        <div class="form-group">
            <label>æ—¥æœŸ</label>
            <input type="text" id="cal-display-date" disabled style="background-color: #e9ecef;">
        </div>

        <div class="form-group">
            <label>ç±»å‹</label>
            <select id="cal-type" onchange="toggleSwapDate()">
                <option value="holiday">æ”¾å‡</option>
                <option value="swap">è°ƒè¯¾</option>
            </select>
        </div>

        <div class="form-group" id="group-swap-date" style="display: none;">
            <label>è°ƒè¯¾è¡¥ç­æ—¥æœŸ (å³å½“å¤©è¦ä¸Šå“ªä¸€å¤©çš„è¯¾)</label>
            <input type="date" id="cal-swap-date">
            <small style="color: #666;">ä¾‹å¦‚ï¼š10æœˆ7æ—¥ä¸Šç­ï¼Œè¡¥çš„æ˜¯10æœˆ5æ—¥çš„è¯¾</small>
        </div>

        <div class="form-group">
            <label>å¤‡æ³¨è¯´æ˜</label>
            <input type="text" id="cal-desc" placeholder="ä¾‹å¦‚ï¼šå›½åº†èŠ‚æ”¾å‡">
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCalendarModal()">å–æ¶ˆ</button>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="btn-cal-delete" onclick="deleteCalendarEvent()"
                        style="display: none;">åˆ é™¤
                </button>
                <button class="btn btn-primary" onclick="saveCalendarEvent()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== å¸¸é‡å®šä¹‰ ====================
    const CALENDAR_TYPES = {
        HOLIDAY: {code: 'holiday', label: 'æ”¾å‡'},
        SWAP: {code: 'swap', label: 'è°ƒè¯¾'}
    };
    const API_BASE = '/config';

    // çŠ¶æ€å­˜å‚¨
    const state = {
        lab: {pageNo: 1, pageSize: 10, total: 0},
        account: {pageNo: 1, pageSize: 10, total: 0},
        calendar: {
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1, // 1-12
            events: [] // å­˜å‚¨å½“å‰æœˆçš„äº‹ä»¶æ•°æ®
        }
    };

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadLabData();
        // åˆå§‹ä¸åŠ è½½æ—¥å†ï¼Œç­‰åˆ‡è¿‡å»å†åŠ è½½
    });

    function switchTab(module) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`${module}-tab`).classList.add('active');
        // å…¼å®¹æ—§çš„æŒ‰é’®æ ·å¼æŸ¥æ‰¾
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            if (btn.getAttribute('onclick').includes(module)) btn.classList.add('active');
        });

        if (module === 'lab') loadLabData();
        if (module === 'account') loadAccountData();
        if (module === 'calendar') renderCalendar(); // åˆ‡æ¢æ—¶æ¸²æŸ“æ—¥å†
    }

    // ==================== 1 & 2. å®éªŒå®¤ä¸è´¦å· (åˆ—è¡¨é€»è¾‘ä¿æŒ) ====================
    // ç®€ç•¥ç‰ˆ Fetch å°è£…
    async function fetchData(module, endpoint) {
        const {pageNo, pageSize} = state[module];
        try {
            const res = await fetch(`${API_BASE}${endpoint}?pageNo=${pageNo}&pageSize=${pageSize}`);
            const data = await res.json();
            state[module].total = data.total;
            state[module].pages = data.pages; // å‡è®¾åç«¯è¿”å›æ€»é¡µæ•°
            renderList(module, data.list);
            renderPagination(module);
        } catch (e) {
            showMsg('error', `åŠ è½½å¤±è´¥: ${e.message}`);
        }
    }

    function loadLabData() {
        fetchData('lab', '/lab/list');
    }

    function loadAccountData() {
        fetchData('account', '/account/list');
    }

    function renderList(module, list) {
        const tbody = document.getElementById(`${module}-list`);
        tbody.innerHTML = '';
        if (!list) return;
        list.forEach(item => tbody.appendChild(createRowElement(module, item)));
    }

    function createRowElement(module, data = {}) {
        const tr = document.createElement('tr');
        tr.dataset.id = data.id || '';
        const isNew = !data.id;
        let html = '';

        if (module === 'lab') {
            html = `
                <td><input class="inp-name" value="${data.name || ''}" placeholder="ä¾‹å¦‚: ç¿”å®‰"></td>
                <td><input class="inp-lab" value="${data.lab || ''}" placeholder="å®éªŒå®¤åç§°"></td>
                <td><input class="inp-excluded" value="${(data.excluded_name || []).join(', ')}" placeholder="å§“åé€—å·éš”å¼€"></td>`;
        } else if (module === 'account') {
            html = `
                <td><input class="inp-name" value="${data.name || ''}" placeholder="å§“å"></td>
                <td><input class="inp-mobile" value="${data.mobile || ''}" placeholder="æ‰‹æœºå·"></td>
                 <td><input class="inp-pwd" type="text" value="${data.password || ''}" placeholder="å¯†ç "></td>
                <td><input class="inp-email" value="${data.email || ''}" placeholder="é‚®ç®±"></td>`;
        }

        html += `<td class="action-buttons">
                    <button class="row-btn save-row-btn" onclick="saveListData('${module}', this)">ä¿å­˜</button>
                    <button class="row-btn delete-row-btn" onclick="deleteListData('${module}', this)">${isNew ? 'ç§»é™¤' : 'åˆ é™¤'}</button>
                 </td>`;
        tr.innerHTML = html;
        return tr;
    }

    function addRow(module) {
        document.getElementById(`${module}-list`).prepend(createRowElement(module, {}));
    }

    // --- åˆ—è¡¨ä¿å­˜ä¸åˆ é™¤ (é€šç”¨) ---
    async function saveListData(module, btn) {
        const tr = btn.closest('tr');
        const id = tr.dataset.id ? parseInt(tr.dataset.id) : null;
        let payload = {id};
        let url = '';

        if (module === 'lab') {
            payload.name = tr.querySelector('.inp-name').value.trim();
            payload.lab = tr.querySelector('.inp-lab').value.trim();
            const ex = tr.querySelector('.inp-excluded').value.trim();
            payload.excluded_name = ex ? ex.split(/,|ï¼Œ/).map(s => s.trim()) : [];
            url = '/lab/add';
        } else {
            payload.name = tr.querySelector('.inp-name').value.trim();
            payload.mobile = tr.querySelector('.inp-mobile').value.trim();
            const pwd = tr.querySelector('.inp-pwd').value.trim();
            payload.email = tr.querySelector('.inp-email').value.trim();
            if (pwd) payload.password = pwd;
            url = '/account/add';
        }

        handleApiRequest(url, payload, () => {
            if (module === 'lab') loadLabData(); else loadAccountData();
        });
    }

    async function deleteListData(module, btn) {
        const tr = btn.closest('tr');
        if (!tr.dataset.id) return tr.remove();
        if (!confirm('ç¡®å®šåˆ é™¤?')) return;

        const url = `${API_BASE}/${module}/${tr.dataset.id}/delete`;
        // å¤ç”¨è¯·æ±‚é€»è¾‘ï¼Œè™½ç„¶è¿™é‡Œæ˜¯POSTä½†æ²¡bodyï¼Œç¨å¾®é€‚é…ä¸‹
        handleApiRequest(url, {}, () => {
            if (module === 'lab') loadLabData(); else loadAccountData();
        });
    }

    // ==================== 3. ğŸ“… æ—¥å†æ ¸å¿ƒé€»è¾‘ (å…¨æ–°) ====================

    // åˆ‡æ¢æœˆä»½
    function changeMonth(delta) {
        let {year, month} = state.calendar;
        month += delta;
        if (month > 12) {
            month = 1;
            year++;
        }
        if (month < 1) {
            month = 12;
            year--;
        }
        state.calendar.year = year;
        state.calendar.month = month;
        renderCalendar();
    }

    // æ¸²æŸ“æ—¥å†ä¸»å…¥å£
    async function renderCalendar() {
        const {year, month} = state.calendar;

        // æ›´æ–°é¡¶éƒ¨æœˆä»½æ˜¾ç¤º
        document.getElementById('current-month-display').innerText = `${year} å¹´ ${month} æœˆ`;
        const container = document.getElementById('calendar-body');

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        container.innerHTML = '<div style="grid-column: 1/-1; padding: 30px; text-align: center; color: #666;">åŠ è½½ä¸­...</div>';

        try {
            // è¯·æ±‚åç«¯æ¥å£è·å–å½“æœˆæ•°æ®
            const res = await fetch(`${API_BASE}/calendar/range?year=${year}&month=${month}`);
            const data = await res.json();
            state.calendar.events = data.list || [];
        } catch (e) {
            console.error("åŠ è½½æ—¥å†æ•°æ®å¤±è´¥", e);
            state.calendar.events = [];
            // å¤±è´¥æ—¶ä¹Ÿå¯ä»¥æ¸…ç©ºï¼Œæˆ–è€…ä¿ç•™ç©ºæ•°ç»„è®©æ—¥å†æ¸²æŸ“å‡ºç©ºæ ¼å­
        }

        // æ¸…ç©ºå®¹å™¨å‡†å¤‡æ¸²æŸ“
        container.innerHTML = '';

        // è®¡ç®—æ—¥æœŸé€»è¾‘
        const firstDayOfMonth = new Date(year, month - 1, 1).getDay(); // å½“æœˆç¬¬ä¸€å¤©æ˜¯å‘¨å‡  (0-6)
        const daysInMonth = new Date(year, month, 0).getDate(); // å½“æœˆæœ‰å¤šå°‘å¤©
        const todayStr = new Date().toISOString().split('T')[0]; // ä»Šå¤©æ—¥æœŸ YYYY-MM-DD

        // 1. è¡¥å……ä¸Šä¸ªæœˆçš„ç©ºç™½æ ¼å­
        for (let i = 0; i < firstDayOfMonth; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell other-month';
            container.appendChild(cell);
        }

        // 2. ç”Ÿæˆå½“æœˆçš„æ¯ä¸€å¤©
        for (let day = 1; day <= daysInMonth; day++) {
            // æ„é€ æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            const cell = document.createElement('div');
            cell.className = 'calendar-cell';

            // æ ‡è®°ä»Šå¤©
            if (dateStr === todayStr) cell.classList.add('today');

            // æŸ¥æ‰¾å½“å¤©æ˜¯å¦æœ‰é…ç½®æ•°æ®
            const eventData = state.calendar.events.find(e => e.date === dateStr);

            // åŸºç¡€HTMLï¼šæ—¥æœŸæ•°å­—
            let contentHtml = `<div class="day-number">${day}</div>`;

            // å¦‚æœæœ‰é…ç½®ï¼ˆæ”¾å‡æˆ–è°ƒè¯¾ï¼‰
            if (eventData) {
                const isHoliday = eventData.type === 'holiday';
                const badgeClass = isHoliday ? 'badge-holiday' : 'badge-swap';
                let badgeText = '';

                // --- æ ‡ç­¾æ–‡å­—é€»è¾‘ ---
                if (isHoliday) {
                    badgeText = 'æ”¾å‡';
                } else {
                    // è°ƒè¯¾é€»è¾‘ï¼šæ˜¾ç¤ºè¡¥ç­æ—¥æœŸ
                    if (eventData.swap_date) {
                        const parts = eventData.swap_date.split('-');
                        // å°è¯•è§£æä¸º MæœˆDæ—¥
                        if (parts.length === 3) {
                            badgeText = `è°ƒè¯¾ ${parseInt(parts[1])}æœˆ${parseInt(parts[2])}æ—¥`;
                        } else {
                            badgeText = 'è°ƒè¯¾';
                        }
                    } else {
                        badgeText = 'è°ƒè¯¾ (æœªè®¾ç½®)';
                    }
                }

                // --- æè¿°æ–‡å­—æˆªæ–­é€»è¾‘ (æ–°å¢) ---
                const rawDesc = eventData.description || '';
                let displayDesc = rawDesc;

                // å¦‚æœå¤§äº12ä¸ªå­—ç¬¦ï¼Œæˆªå–å‰10ä¸ªå¹¶åŠ çœç•¥å·
                if (rawDesc.length > 12) {
                    displayDesc = rawDesc.substring(0, 10) + '...';
                }

                // æ‹¼è£… HTML
                // titleå±æ€§ç”¨äºé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´å†…å®¹
                contentHtml += `
                    <div class="event-badge ${badgeClass}">${badgeText}</div>
                    ${rawDesc ? `<div class="event-desc">${displayDesc}</div>` : ''}
                `;
            }

            cell.innerHTML = contentHtml;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œæ‰“å¼€å¼¹çª—
            cell.onclick = () => openCalendarModal(dateStr, eventData);

            container.appendChild(cell);
        }
    }

    // ==================== ğŸ“… æ—¥å†å¼¹çª—é€»è¾‘ ====================

    function openCalendarModal(dateStr, eventData) {
        const modal = document.getElementById('calendar-edit-modal');
        const title = document.getElementById('cal-modal-title');

        // å¡«å……æ•°æ®
        document.getElementById('cal-date').value = dateStr;
        document.getElementById('cal-display-date').value = dateStr;

        if (eventData) {
            // ç¼–è¾‘æ¨¡å¼
            title.innerText = 'ç¼–è¾‘è°ƒè¯¾é…ç½®';
            document.getElementById('cal-id').value = eventData.id;
            document.getElementById('cal-type').value = eventData.type;
            document.getElementById('cal-desc').value = eventData.description || '';
            document.getElementById('cal-swap-date').value = eventData.swap_date || '';
            document.getElementById('btn-cal-delete').style.display = 'inline-block';
        } else {
            // æ–°å¢æ¨¡å¼
            title.innerText = 'æ–°å¢è°ƒè¯¾é…ç½®';
            document.getElementById('cal-id').value = '';
            document.getElementById('cal-type').value = 'holiday'; // é»˜è®¤æ”¾å‡
            document.getElementById('cal-desc').value = '';
            document.getElementById('cal-swap-date').value = '';
            document.getElementById('btn-cal-delete').style.display = 'none';
        }

        toggleSwapDate(); // æ ¹æ®å½“å‰ç±»å‹æ˜¾ç¤º/éšè—è¡¥ç­æ—¥æœŸ
        modal.style.display = 'flex';
    }

    function closeCalendarModal() {
        document.getElementById('calendar-edit-modal').style.display = 'none';
    }

    function toggleSwapDate() {
        const type = document.getElementById('cal-type').value;
        const group = document.getElementById('group-swap-date');
        group.style.display = (type === 'swap') ? 'block' : 'none';
    }

    // ä¿å­˜æ—¥å†é…ç½®
    async function saveCalendarEvent() {
        const id = document.getElementById('cal-id').value;
        const date = document.getElementById('cal-date').value;
        const type = document.getElementById('cal-type').value;
        const desc = document.getElementById('cal-desc').value;
        const swapDate = document.getElementById('cal-swap-date').value;

        // éªŒè¯
        if (type === 'swap' && !swapDate) {
            alert('è°ƒè¯¾ç±»å‹å¿…é¡»é€‰æ‹©â€œè¡¥ç­æ—¥æœŸâ€');
            return;
        }

        const payload = {
            id: id ? parseInt(id) : null,
            date: date,
            type: type,
            description: desc,
            swap_date: (type === 'swap') ? swapDate : null
        };

        // å…³é—­ç¼–è¾‘å¼¹çª—ï¼Œæ˜¾ç¤ºLoading
        closeCalendarModal();
        handleApiRequest('/calendar/add', payload, () => renderCalendar());
    }

    // åˆ é™¤æ—¥å†é…ç½®
    async function deleteCalendarEvent() {
        const id = document.getElementById('cal-id').value;
        if (!id) return;

        if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å¤©çš„é…ç½®å—ï¼Ÿ')) return;

        closeCalendarModal();
        handleApiRequest(`/calendar/${id}/delete`, {}, () => renderCalendar());
    }

    // ==================== é€šç”¨å·¥å…· ====================

    // ç»Ÿä¸€å¤„ç† Fetch è¯·æ±‚ä¸åé¦ˆ
    async function handleApiRequest(url, payload, onSuccess) {
        showMsg('loading', 'æ­£åœ¨å¤„ç†...');
        try {
            const res = await fetch(API_BASE + url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.success) {
                showMsg('success', result.message || 'æ“ä½œæˆåŠŸ');
                if (onSuccess) onSuccess();
            } else {
                throw new Error(result.error || 'æ“ä½œå¤±è´¥');
            }
        } catch (e) {
            showMsg('error', e.message);
        }
    }

    // æ¶ˆæ¯å¼¹çª—
    const msgModal = document.getElementById('msg-modal');
    const msgBody = document.getElementById('msg-body');
    const msgBtns = document.getElementById('msg-buttons');

    function showMsg(type, text) {
        msgBody.innerHTML = '';
        msgBtns.innerHTML = '';
        msgModal.style.display = 'flex';

        if (type === 'loading') {
            msgBody.innerHTML = `<div class="spinner"></div><p style="margin-top:10px">${text}</p>`;
        } else {
            const color = type === 'error' ? 'red' : 'green';
            msgBody.innerHTML = `<p style="font-size:16px; color:${color}">${text}</p>`;
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = 'ç¡®å®š';
            btn.onclick = () => msgModal.style.display = 'none';
            msgBtns.appendChild(btn);
        }
    }

    // åˆ†é¡µå¤„ç†ï¼ˆä»…ç”¨äºåˆ—è¡¨ï¼‰
    function renderPagination(module) {
        const s = state[module];
        document.getElementById(`${module}-pagination`).innerHTML = `
            <div style="font-size:14px;color:#666">å…± ${s.total} æ¡ï¼Œé¡µ ${s.pageNo}/${s.pages || 1}</div>
            <button class="page-btn" ${s.pageNo <= 1 ? 'disabled' : ''} onclick="changePage('${module}', -1)">ä¸Šä¸€é¡µ</button>
            <button class="page-btn" ${s.pageNo >= s.pages ? 'disabled' : ''} onclick="changePage('${module}', 1)">ä¸‹ä¸€é¡µ</button>
        `;
    }

    function changePage(module, d) {
        state[module].pageNo += d;
        if (module === 'lab') loadLabData(); else loadAccountData();
    }
</script>

</body>
</html>